# .github/workflows/docker-ci.yml
name: Build & Deploy Docker Images

on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & push flow image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: infrastructure/prefect/flow/Dockerfile.flow
          push: true
          tags: mrschrodingers/pipeboard-flow:${{ github.sha }}

      - name: Build & push worker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: infrastructure/prefect/worker/Dockerfile.worker
          push: true
          tags: mrschrodingers/pipeboard-worker:${{ github.sha }}

  deploy-prefect:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Wait for Prefect Server
        run: |
          until curl -sf http://orion.example.com/api/health; do
            echo "Waiting for Prefect Server..."; sleep 5;
          done

      - name: Create/Update Blocks
        env:
          PREFECT_API_URL: http://orion.example.com/api
          GITHUB_PAT: ${{ secrets.GITHUB_PAT }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          DOCKER_USER: ${{ secrets.DOCKERHUB_USER }}
          DOCKER_PASS: ${{ secrets.DOCKERHUB_TOKEN }}
          DOCKER_REGISTRY_URL: docker.io
        run: |
          python docker/utils/create_or_update_core_blocks.py

      - name: Apply Deployments
        env:
          PREFECT_API_URL: http://orion.example.com/api
          PREFECT_API_AUTH_STRING: ${{ secrets.PREFECT_SERVER_API_AUTH_STRING }}
        run: |
          python docker/utils/blocks_and_deployments.py
